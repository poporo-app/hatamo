# HATAMOマッチングサービス - 招待コード仕様

**作成日**: 2025年9月21日
**バージョン**: v3.0
**更新**: 招待コード発行・管理仕様の詳細化

---

## 1. 招待コード生成仕様

| 項目 | 仕様 |
|------|------|
| **コード形式** | 英数字ランダム8文字（例: A3X9K2M7） |
| **ユーザータイプ指定** | CLIENT（利用者）/ SPONSOR（スポンサー）から選択 |
| **有効期限設定** | 7日 / 14日 / 30日 / 無期限 から選択可能（デフォルト: 30日） |
| **発行数** | 単発発行 または 一括発行（1〜100件） |
| **メモ機能** | 発行目的・対象者メモ（最大500文字） |
| **重複チェック** | 既存コードとの重複を自動排除 |

## 2. 招待コード管理機能

| 機能 | 詳細 |
|------|------|
| **ステータス表示** | 未使用 / 使用済み / 期限切れ / 無効化 |
| **使用者情報** | 使用済みの場合、使用者名・メールアドレス・使用日時を表示 |
| **発行履歴** | 発行日時、発行者、ユーザータイプ、有効期限を一覧表示 |
| **検索・フィルター** | ステータス、ユーザータイプ、発行日、有効期限で絞り込み |
| **一括操作** | 選択した招待コードの一括無効化 |
| **エクスポート** | CSV/Excelファイルでのダウンロード機能 |
| **コピー機能** | ワンクリックでコードをクリップボードにコピー |
| **メール送信** | 個別送信：招待コードを選択してメールアドレス入力で送信 |
| **一括メール送信** | CSV読み込みで複数の招待コードを一括送信 |
| **送信履歴** | 送信先メールアドレス、送信日時、送信結果を表示 |

## 3. 招待コード発行フロー

```
1. 管理者ログイン
2. 招待コード管理画面へ移動
3. 「新規発行」ボタンクリック
4. 発行設定入力
   - ユーザータイプ選択（CLIENT / SPONSOR）
   - 発行数入力（1〜100）
   - 有効期限選択
   - メモ入力（任意）
5. 「発行」ボタンクリック
6. 確認ダイアログ表示
7. 招待コード生成完了
8. 生成されたコード一覧を表示（コピー可能）
9. オプション選択
   - CSV/Excelでエクスポート
   - メール送信（個別または一括）
```

## 4. 招待コード一覧画面項目

| 表示項目 | 説明 |
|---------|------|
| 選択 | チェックボックス（一括操作用） |
| コード | 8文字の招待コード（クリックでコピー） |
| ユーザータイプ | CLIENT / SPONSOR |
| ステータス | 未使用 / 使用済み / 期限切れ / 無効化 |
| 発行日時 | YYYY-MM-DD HH:mm |
| 有効期限 | YYYY-MM-DD または「無期限」 |
| 使用者 | 使用済みの場合、ユーザー名を表示 |
| 使用日時 | 使用済みの場合、使用日時を表示 |
| 送信先 | メール送信済みの場合、送信先メールアドレスを表示 |
| 送信日時 | メール送信済みの場合、送信日時を表示 |
| メモ | 発行時のメモ（省略表示、クリックで全文表示） |
| 操作 | 詳細表示 / メール送信 / 無効化ボタン |

## 5. データベース設計

### 5.1 InviteCodeテーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| code | String | 招待コード（ユニーク、8文字） |
| userType | Enum | CLIENT / SPONSOR / ADMIN |
| status | Enum | ACTIVE / USED / EXPIRED / DISABLED |
| expiresAt | DateTime | 有効期限（NULL=無期限） |
| memo | String | 発行メモ（最大500文字） |
| usedBy | UUID | 使用者ID（外部キー: User.id） |
| usedAt | DateTime | 使用日時 |
| createdBy | UUID | 発行者ID（外部キー: User.id） |
| createdAt | DateTime | 発行日時 |
| updatedAt | DateTime | 更新日時 |

### 5.2 InviteEmailLogテーブル

| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| inviteCodeId | UUID | 招待コードID（外部キー: InviteCode.id） |
| recipientEmail | String | 送信先メールアドレス |
| recipientName | String | 宛名（任意） |
| sentAt | DateTime | 送信日時 |
| sentBy | UUID | 送信者ID（外部キー: User.id） |
| status | Enum | SUCCESS / FAILED |
| errorMessage | String | エラーメッセージ（失敗時のみ） |
| emailSubject | String | メール件名 |
| emailBody | Text | メール本文 |
| createdAt | DateTime | レコード作成日時 |

## 6. 招待コード使用フロー

```
1. ユーザーが新規登録画面で招待コード入力
2. バックエンドで招待コード検証
   - コードの存在確認
   - ステータスチェック（ACTIVE であること）
   - 有効期限チェック（期限内であること）
3. 検証成功 → ユーザータイプを自動判定して表示
4. ユーザー登録完了時
   - InviteCode.status を USED に更新
   - InviteCode.usedBy にユーザーIDを設定
   - InviteCode.usedAt に使用日時を記録
5. 検証失敗 → エラーメッセージ表示
   - 「招待コードが無効です」
   - 「この招待コードは既に使用されています」
   - 「招待コードの有効期限が切れています」
```

## 7. 招待コードメール送信機能

### 7.1 個別送信機能

| 項目 | 仕様 |
|------|------|
| **送信対象** | 招待コード一覧から1件選択 |
| **入力項目** | 送信先メールアドレス（必須）、宛名（任意） |
| **バリデーション** | メール形式チェック、ドメイン検証 |
| **プレビュー** | 送信前にメール内容をプレビュー表示 |
| **送信処理** | 確認ダイアログ → 送信実行 → 結果表示 |

### 7.2 個別送信フロー

```
1. 招待コード一覧から送信対象コードを選択
2. 「メール送信」ボタンクリック
3. 送信フォーム表示
   - 招待コード: A3X9K2M7（表示のみ）
   - 送信先メールアドレス: [入力欄]
   - 宛名: [入力欄]（任意）
4. 「プレビュー」ボタンクリック
5. メール内容プレビュー表示
6. 「送信」ボタンクリック
7. 確認ダイアログ表示
8. 送信処理実行
9. 送信結果表示
   - 成功: 「招待コードを送信しました」
   - 失敗: エラーメッセージ表示
10. InviteEmailLogテーブルに送信履歴を記録
```

### 7.3 CSV一括送信機能（後回しでも可）

| 項目 | 仕様 |
|------|------|
| **CSV形式** | カラム: `email` (必須), `name` (任意), `code` (任意: 未指定の場合は未使用コードから自動割当) |
| **アップロード** | CSVファイルをドラッグ&ドロップまたはファイル選択 |
| **バリデーション** | メール形式チェック、重複チェック、招待コード存在確認 |
| **プレビュー** | 送信対象リスト表示（件数、エラー件数） |
| **送信処理** | 一括送信実行 → 進捗表示 → 結果レポート |
| **結果レポート** | 成功件数、失敗件数、エラー詳細リスト |
| **エラー処理** | 失敗分のみCSVでダウンロード可能 |

### 7.4 CSV一括送信フロー

```
1. 招待コード管理画面で「一括メール送信」ボタンクリック
2. CSV一括送信画面表示
3. CSVファイルアップロード
   - サンプルCSVダウンロードリンク提供
4. CSVバリデーション実行
   - メール形式チェック
   - 招待コード存在確認（code列が指定されている場合）
   - 重複チェック
5. バリデーション結果表示
   - エラーがある場合: エラー詳細リスト表示
   - 正常の場合: 送信対象プレビュー表示
6. 「一括送信」ボタンクリック
7. 確認ダイアログ表示（送信件数を表示）
8. 一括送信処理実行
   - 進捗バー表示（○○ / ○○ 件送信中）
9. 送信完了後、結果レポート表示
   - 成功: ○○件
   - 失敗: ○○件
   - エラー詳細リストテーブル
10. 失敗分のCSVダウンロードボタン表示
11. InviteEmailLogテーブルに全送信履歴を記録
```

### 7.5 CSV一括送信用サンプルファイル

```csv
email,name,code
tanaka@example.com,田中太郎,A3X9K2M7
sato@example.com,佐藤花子,
yamada@example.com,山田次郎,B5K8L3P9
```

**注意**: `code` 列が空の場合、未使用の招待コードから自動割当

### 7.6 メールテンプレート

```
件名: 【HATAMO】招待コードのご案内

{宛名}様

HATAMOマッチングサービスへのご招待です。
以下の招待コードを使用して、会員登録を完了してください。

━━━━━━━━━━━━━━━━━━━━━━━━
招待コード: {招待コード}
登録タイプ: {ユーザータイプ}
有効期限: {有効期限}
━━━━━━━━━━━━━━━━━━━━━━━━

▼ 会員登録はこちら
{登録URL}?code={招待コード}

※このメールは自動送信されています。
※招待コードは第三者に共有しないでください。
※有効期限内に登録を完了してください。

━━━━━━━━━━━━━━━━━━━━━━━━
HATAMO運営チーム
お問い合わせ: support@hatamo.jp
━━━━━━━━━━━━━━━━━━━━━━━━
```

---

**関連ドキュメント**:
- [プロジェクト概要](./01-project-overview.md)
- [機能要件](./02-feature-requirements.md)
- [技術要件](./04-technical-requirements.md)
- [開発計画](./05-development-plan.md)
