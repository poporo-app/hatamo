## 付録

### A. カラーコード一覧（Tailwind CSS変数）

```css
/* globals.css */
@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --primary: 221.2 83.2% 53.3%; /* Blue-600 */
    --primary-foreground: 210 40% 98%;
    --secondary: 24.6 95% 53.1%; /* Orange-500 */
    --secondary-foreground: 0 0% 98%;
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 210 40% 96.1%;
    --accent-foreground: 222.2 47.4% 11.2%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 221.2 83.2% 53.3%;
    --radius: 0.5rem;
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    /* ... */
  }
}
```

### B. アニメーション定義

```css
/* globals.css */
@layer utilities {
  @keyframes slide-in-right {
    from {
      transform: translateX(100%);
    }
    to {
      transform: translateX(0);
    }
  }

  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .animate-slide-in-right {
    animation: slide-in-right 0.3s ease-out;
  }

  .animate-fade-in {
    animation: fade-in 0.2s ease-in;
  }
}
```

### C. 主要コンポーネント使用例

#### Button

```tsx
import { Button } from "@/components/ui/button";

<Button variant="default">送信</Button>
<Button variant="secondary">キャンセル</Button>
<Button variant="outline">詳細</Button>
<Button variant="ghost">閉じる</Button>
<Button variant="destructive">削除</Button>
```

#### Card

```tsx
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from "@/components/ui/card";

<Card>
  <CardHeader>
    <CardTitle>カードタイトル</CardTitle>
    <CardDescription>説明文</CardDescription>
  </CardHeader>
  <CardContent>
    <p>コンテンツ</p>
  </CardContent>
  <CardFooter>
    <Button>アクション</Button>
  </CardFooter>
</Card>
```

#### Dialog

```tsx
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";

<Dialog open={isOpen} onOpenChange={setIsOpen}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>ダイアログタイトル</DialogTitle>
      <DialogDescription>説明文</DialogDescription>
    </DialogHeader>
    <div>コンテンツ</div>
    <DialogFooter>
      <Button onClick={() => setIsOpen(false)}>キャンセル</Button>
      <Button onClick={handleConfirm}>確定</Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
```

---

## 8. データベーススキーマ更新

### 8.1 Bookingテーブル更新

#### 新規カラム追加

```prisma
model Booking {
  id String @id @default(uuid())
  serviceId String @map("service_id")
  clientId String @map("client_id")
  sponsorId String @map("sponsor_id")

  status BookingStatus @default(PENDING)
  totalPrice Int @map("total_price")
  feeAmount Int @map("fee_amount")
  feeRate Int @map("fee_rate") // 手数料率（20/30/40/50）

  // 日時カラム
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  acceptedAt DateTime? @map("accepted_at")     // パートナーが承認した日時
  paidAt DateTime? @map("paid_at")             // 決済完了日時
  startedAt DateTime? @map("started_at")       // 作業開始日時
  completedAt DateTime? @map("completed_at")   // パートナーが完了報告した日時
  approvedAt DateTime? @map("approved_at")     // ★新規追加：利用者が完了承認した日時
  cancelledAt DateTime? @map("cancelled_at")   // キャンセル日時

  // Stripe決済情報
  stripePaymentIntentId String? @map("stripe_payment_intent_id")
  stripeRefundId String? @map("stripe_refund_id")

  // 申込情報
  requestNote String? @db.Text @map("request_note") // 利用者からの要望
  cancelReason String? @db.Text @map("cancel_reason") // キャンセル理由

  // Relations
  service Service @relation(fields: [serviceId], references: [id])
  client User @relation("ClientBookings", fields: [clientId], references: [id])
  sponsor User @relation("SponsorBookings", fields: [sponsorId], references: [id])
  messages Message[]
  review Review?
  revisionRequests BookingRevisionRequest[] // ★新規追加

  @@map("bookings")
  @@index([clientId])
  @@index([sponsorId])
  @@index([status])
  @@index([createdAt])
}
```

#### BookingStatus Enum 更新

```prisma
enum BookingStatus {
  PENDING              // 承認待ち
  REJECTED             // 拒否
  ACCEPTED             // 承認済み（決済待ち）
  PAID                 // 決済完了
  IN_PROGRESS          // 作業中
  AWAITING_COMPLETION  // ★新規追加：完了確認待ち
  COMPLETED            // 完了
  CANCELLED            // キャンセル（決済前）
  REFUNDED             // 返金済み（決済後キャンセル）
}
```

### 8.2 BookingRevisionRequest テーブル新規作成

#### テーブル定義

```prisma
model BookingRevisionRequest {
  id String @id @default(uuid())
  bookingId String @map("booking_id")
  requestedBy String @map("requested_by") // 利用者ID
  revisionNote String @db.Text @map("revision_note") // 修正内容
  status RevisionStatus @default(PENDING)
  createdAt DateTime @default(now()) @map("created_at")
  resolvedAt DateTime? @map("resolved_at")
  resolvedBy String? @map("resolved_by") // パートナーID
  responseNote String? @db.Text @map("response_note") // パートナーからの返信

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client User @relation("ClientRevisionRequests", fields: [requestedBy], references: [id])
  sponsor User? @relation("SponsorRevisionRequests", fields: [resolvedBy], references: [id])

  @@map("booking_revision_requests")
  @@index([bookingId])
  @@index([requestedBy])
  @@index([status])
  @@index([createdAt])
}
```

#### RevisionStatus Enum 新規作成

```prisma
enum RevisionStatus {
  PENDING   // 修正依頼中
  RESOLVED  // 修正完了
  REJECTED  // 修正拒否（例外的なケース）
}
```

### 8.3 User テーブルへのリレーション追加

```prisma
model User {
  id String @id @default(uuid())
  email String @unique
  passwordHash String @map("password_hash")
  userType UserType @map("user_type")
  name String
  profileImage String? @map("profile_image")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  usedInviteCode InviteCode? @relation("InviteCodeUser")
  services Service[]
  clientBookings Booking[] @relation("ClientBookings")
  sponsorBookings Booking[] @relation("SponsorBookings")
  sentMessages Message[] @relation("SentMessages")
  clientConversations Conversation[] @relation("ClientConversations")
  sponsorConversations Conversation[] @relation("SponsorConversations")

  // ★新規追加：修正依頼関連
  clientRevisionRequests BookingRevisionRequest[] @relation("ClientRevisionRequests")
  sponsorRevisionRequests BookingRevisionRequest[] @relation("SponsorRevisionRequests")

  @@map("users")
}
```

### 8.4 マイグレーションコマンド

```bash
# Prismaスキーマ更新後、以下のコマンドを実行

# マイグレーションファイル生成
npx prisma migrate dev --name add_awaiting_completion_and_revision_requests

# Prisma Clientを再生成
npx prisma generate

# データベース接続確認
npx prisma db push

# Prisma Studioで確認
npx prisma studio
```

### 8.5 既存データのマイグレーション注意点

**AWAITING_COMPLETION ステータス追加による影響**:

既存のBookingレコードで `status = 'IN_PROGRESS'` かつ `completedAt` が設定されているレコードは、`AWAITING_COMPLETION` に変更する必要がある可能性があります。

```sql
-- 既存データの修正例（必要に応じて実行）
UPDATE bookings
SET status = 'AWAITING_COMPLETION'
WHERE status = 'IN_PROGRESS'
  AND completed_at IS NOT NULL
  AND approved_at IS NULL;
```

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|--------|
| v1.0 | 2025/10/02 | 初版作成 | 設計チーム |
| v1.1 | 2025/10/02 | ユーザーフロー修正: 新規ユーザーと既存ユーザーのフロー分離、アクセス制御の明確化 | 設計チーム |
| v1.2 | 2025/10/02 | ワイヤーフレーム追加: 利用者ダッシュボード（5.2）を追加 | 設計チーム |
| v1.3 | 2025/10/05 | ワイヤーフレーム追加: パートナー向けサービス一覧（マイサービス）（5.7）を追加。検索・フィルター機能、統計カード、データ構造、API仕様、インタラクション仕様、レスポンシブ対応を詳細化 | 設計チーム |
| v1.4 | 2025/10/05 | ワイヤーフレーム追加: 利用者向けマイ申込一覧（5.8）、パートナー向け申込管理（5.9）、申込詳細画面（5.10）を追加。BookingStatus（7段階）に対応したステータス管理、進行バー、タイムライン、アクションボタン、手数料計算ロジック、API仕様、データ構造、インタラクション仕様、レスポンシブ対応を詳細化 | 設計チーム |
| v1.5 | 2025/10/06 | **重要更新**: AWAITING_COMPLETION（完了確認待ち）ステータスを追加。利用者による完了承認フローを実装。修正依頼機能（BookingRevisionRequestテーブル）を追加。パートナー申込管理画面（5.9）にステータス遷移フロー詳細を追加。データベーススキーマセクション（8章）を新規追加。売上確定タイミングを「利用者の承認後」に変更。 | 設計チーム |
| v1.6 | 2025/10/06 | **申込詳細画面（5.10）を更新**: ステータス進行バーを6ステップに拡張（確認待ちステップを追加）。パートナー視点・利用者視点のアクションにAWAITING_COMPLETION対応を追加。修正依頼エリアを新規追加（ワイヤーフレーム、データ構造、アクション仕様）。アクティビティタイムラインに完了報告・修正依頼・完了承認イベントを追加。APIレスポンスにrevisionRequests配列を追加。 | 設計チーム |
| v1.7 | 2025/10/06 | **招待コード入力ページ（5.11）を新規追加**: 認証フロー第一段階の招待コード検証画面を実装。8文字英数字バリデーション、ユーザータイプ自動判定、エラーハンドリング、API仕様、レスポンシブ対応、アクセシビリティ対応を詳細化。実装ファイル3点を作成（invite-code/page.tsx, client/page.tsx, sponsor/page.tsx）。 | 設計チーム |
| v1.8 | 2025/10/07 | **サービス申込ページ（5.12）を新規追加**: 利用者・パートナー共通のサービス申込ページを実装。2カラムレイアウト（申込フォーム + サービス情報サマリー）、進捗インジケーター、申込者情報入力、希望納期選択、要望・質問事項（500文字制限）、同意チェック（利用規約・プライバシーポリシー・特定商取引法・キャンセルポリシー）、reCAPTCHA v2、料金計算ロジック（基本料金 + 手数料30%/40%/50% + 運営手数料5%）、Stripe決済連携、API仕様（サービス情報取得・申込作成）、決済フロー詳細（PENDING_PAYMENT → AWAITING_APPROVAL → IN_PROGRESS）、エラーハンドリング、レスポンシブ対応（モバイル1カラム・タブレット2カラム・デスクトップ固定サイドバー）、セキュリティ対策を詳細化。実装ファイル7点を定義。 | 設計チーム |

---

**作成者**: HATAMOデザインチーム
**承認者**: プロジェクトマネージャー
**最終更新**: 2025年10月7日（v1.8）
