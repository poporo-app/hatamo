├─────────────────────────────────────────────────────────────┤
│                                                               │
│  申込詳細                                                     │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━      │
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ ステータス進行バー                                      ││
│  ├─────────────────────────────────────────────────────────┤│
│  │                                                         ││
│  │  [●]━━[●]━━[●]━━[●]━━[●]━━[○]                          ││
│  │ 申込中 承認 決済 進行中 確認待ち 完了                   ││
│  │ 10/01 10/02 10/03 10/04  10/05   -                     ││
│  │                                                         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
│  ┌────────────────────┬────────────────────────────────────┐│
│  │ 申込情報           │  アクション                        ││
│  ├────────────────────┼────────────────────────────────────┤│
│  │ 申込番号:          │  [メッセージを送る]                ││
│  │ #BK-2024-001       │                                    ││
│  │                    │  [決済へ進む]                      ││
│  │ サービス:          │                                    ││
│  │ [IMG] Webサイト制作│  [キャンセル]                      ││
│  │                    │                                    ││
│  │ パートナー:        │  ※利用者視点の場合                ││
│  │ 田中太郎           │                                    ││
│  │ ★★★★☆ 4.5        │  ※パートナー視点の場合:           ││
│  │                    │  [承認] [拒否]                     ││
│  │ 金額:              │  [作業開始] [完了マーク]           ││
│  │ ¥50,000            │                                    ││
│  │                    │                                    ││
│  │ 手数料:            │                                    ││
│  │ ¥17,500 (35%)      │                                    ││
│  │                    │                                    ││
│  │ 受取額（パートナー）:│                                  ││
│  │ ¥32,500            │                                    ││
│  │                    │                                    ││
│  │ ステータス:        │                                    ││
│  │ [決済済み]         │                                    ││
│  │                    │                                    ││
│  │ 申込日:            │                                    ││
│  │ 2024/10/01 14:30   │                                    ││
│  │                    │                                    ││
│  │ 更新日:            │                                    ││
│  │ 2024/10/03 10:15   │                                    ││
│  └────────────────────┴────────────────────────────────────┘│
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ アクティビティタイムライン                              ││
│  ├─────────────────────────────────────────────────────────┤│
│  │                                                         ││
│  │  ● 2024/10/03 10:15                                    ││
│  │    決済が完了しました                                   ││
│  │    決済ID: pi_1234567890                               ││
│  │                                                         ││
│  │  ● 2024/10/02 16:45                                    ││
│  │    パートナーが申込を承認しました                       ││
│  │    メッセージ: 「ありがとうございます。お受けします」   ││
│  │                                                         ││
│  │  ● 2024/10/01 14:30                                    ││
│  │    申込を受け付けました                                 ││
│  │                                                         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ サービス詳細                            [サービスページ] ││
│  ├─────────────────────────────────────────────────────────┤│
│  │                                                         ││
│  │  [IMG]                                                  ││
│  │                                                         ││
│  │  Webサイト制作                                          ││
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━      ││
│  │                                                         ││
│  │  コーポレートサイト構築サービス...（説明文）            ││
│  │                                                         ││
│  │  カテゴリ: IT開発                                       ││
│  │  基本料金: ¥50,000〜                                    ││
│  │                                                         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ メッセージ履歴                        [すべて表示]      ││
│  ├─────────────────────────────────────────────────────────┤│
│  │                                                         ││
│  │  田中太郎 (パートナー)                      10/03 10:20 ││
│  │  「決済ありがとうございました。早速着手します」         ││
│  │                                                         ││
│  │  あなた (利用者)                            10/02 17:00 ││
│  │  「承認ありがとうございます。よろしくお願いします」     ││
│  │                                                         ││
│  │  田中太郎 (パートナー)                      10/02 16:45 ││
│  │  「ありがとうございます。お受けします」                 ││
│  │                                                         ││
│  │  [メッセージ入力欄...]                          [送信]  ││
│  │                                                         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 修正依頼 ★AWAITING_COMPLETION時のみ表示                ││
│  ├─────────────────────────────────────────────────────────┤│
│  │                                                         ││
│  │  🔧 利用者から修正依頼があります                         ││
│  │                                                         ││
│  │  ┌───────────────────────────────────────────────────┐  ││
│  │  │ 修正依頼内容:                                     │  ││
│  │  │ ─────────────────────────────────────────────────│  ││
│  │  │                                                   │  ││
│  │  │ ヘッダーのロゴサイズを少し大きくしてほしいです。    │  ││
│  │  │ また、フッターのリンク色を青に変更してください。    │  ││
│  │  │                                                   │  ││
│  │  │ 依頼者: 佐藤花子                                   │  ││
│  │  │ 依頼日時: 2024/10/05 14:30                        │  ││
│  │  └───────────────────────────────────────────────────┘  ││
│  │                                                         ││
│  │  [修正対応完了] [メッセージで確認]                      ││
│  │                                                         ││
│  └─────────────────────────────────────────────────────────┘│
│                                                               │
├─────────────────────────────────────────────────────────────┤
│ Footer: About | Terms | Privacy | Contact                    │
└─────────────────────────────────────────────────────────────┘
```

**要素説明**:

#### ステータス進行バー

**表示形式**:
- **6つのステップ**: 申込中 → 承認 → 決済 → 進行中 → 確認待ち → 完了
- 完了ステップは●（塗りつぶし）、未完了は○（白抜き）
- 各ステップの下に完了日時を表示（未完了は「-」）

**ステータスとステップのマッピング**:

| BookingStatus | 進行バー状態 |
|---------------|-------------|
| PENDING | [●]━━[○]━━[○]━━[○]━━[○]━━[○] |
| ACCEPTED | [●]━━[●]━━[○]━━[○]━━[○]━━[○] |
| PAID | [●]━━[●]━━[●]━━[○]━━[○]━━[○] |
| IN_PROGRESS | [●]━━[●]━━[●]━━[●]━━[○]━━[○] |
| AWAITING_COMPLETION | [●]━━[●]━━[●]━━[●]━━[●]━━[○] |
| COMPLETED | [●]━━[●]━━[●]━━[●]━━[●]━━[●] |
| CANCELLED/REFUNDED | [●]━━[×]（キャンセル表示） |

#### 申込情報エリア

**表示項目**:

| 項目 | 利用者視点 | パートナー視点 |
|------|-----------|---------------|
| 申込番号 | 表示 | 表示 |
| サービス | 表示（画像+タイトル） | 表示（画像+タイトル） |
| 相手情報 | パートナー名+評価 | クライアント名+アバター |
| 金額 | totalPrice | totalPrice |
| 手数料 | 表示（参考情報） | feeAmount（内訳表示） |
| 受取額 | - | totalPrice - feeAmount（重要） |
| ステータス | ステータスバッジ | ステータスバッジ |
| 申込日 | createdAt | createdAt |
| 更新日 | updatedAt | updatedAt |
| 完了日 | completedAt（完了時のみ） | completedAt（完了時のみ） |

#### アクションエリア

**利用者視点のアクション**:

| ステータス | アクション |
|-----------|-----------|
| PENDING | [メッセージを送る] [キャンセル] |
| ACCEPTED | [決済へ進む] [メッセージを送る] [キャンセル] |
| PAID | [メッセージを送る] |
| IN_PROGRESS | [メッセージを送る] |
| AWAITING_COMPLETION | [完了を承認] [修正を依頼] [メッセージを送る] |
| COMPLETED | [レビューを投稿] [メッセージを送る] |
| CANCELLED/REFUNDED | [メッセージを送る]（読み取り専用） |

**パートナー視点のアクション**:

| ステータス | アクション |
|-----------|-----------|
| PENDING | [承認] [拒否] [メッセージを送る] |
| ACCEPTED | [メッセージを送る] [キャンセル] |
| PAID | [作業開始] [メッセージを送る] |
| IN_PROGRESS | [完了マーク] [メッセージを送る] |
| AWAITING_COMPLETION | [メッセージを送る] + 「⏳ 利用者の承認待ちです」メッセージ表示 |
| COMPLETED | [レビューを確認] [メッセージを送る] |
| CANCELLED/REFUNDED | [メッセージを送る]（読み取り専用） |

#### アクティビティタイムライン

**表示内容**:
- 時系列でイベントを表示（新しい順）
- イベント種類:
  - 申込受付
  - 承認/拒否（メッセージ付き）
  - 決済完了（決済ID付き）
  - 作業開始
  - **完了報告（パートナーが完了マークをクリック）** ★新規
  - **修正依頼（利用者が修正依頼を送信）** ★新規
  - **完了承認（利用者が完了を承認）** ★新規
  - レビュー投稿
  - キャンセル（理由付き）

**データ構造**:
```typescript
interface ActivityEvent {
  id: string;
  type: 'CREATED' | 'ACCEPTED' | 'REJECTED' | 'PAID' | 'STARTED' |
        'COMPLETION_REPORTED' | 'REVISION_REQUESTED' | 'COMPLETION_APPROVED' |
        'COMPLETED' | 'REVIEWED' | 'CANCELLED';
  timestamp: Date;
  actor: 'CLIENT' | 'SPONSOR' | 'SYSTEM';
  message?: string;
  metadata?: Record<string, any>;  // 決済ID、修正依頼内容など追加情報
}
```

#### サービス詳細エリア

- サービスの基本情報を表示
- サービス詳細ページへのリンク
- 画像、タイトル、説明（抜粋）、カテゴリ、価格

#### メッセージ履歴エリア

- 最新3件のメッセージを表示
- 「すべて表示」ボタンでメッセージ詳細画面へ遷移
- インライン返信機能（入力欄+送信ボタン）

#### 修正依頼エリア ★新規追加

**表示条件**: `status === 'AWAITING_COMPLETION'` かつ修正依頼が存在する場合のみ表示

**ワイヤーフレーム**:
```
┌─────────────────────────────────────────────────────────┐
│ 修正依頼                                                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  🔧 利用者から修正依頼があります                         │
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │ 修正依頼内容:                                     │  │
│  │ ─────────────────────────────────────────────────│  │
│  │                                                   │  │
│  │ ヘッダーのロゴサイズを少し大きくしてほしいです。    │  │
│  │ また、フッターのリンク色を青に変更してください。    │  │
│  │                                                   │  │
│  │ 依頼者: 佐藤花子                                   │  │
│  │ 依頼日時: 2024/10/05 14:30                        │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
│  [修正対応完了] [メッセージで確認]                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**表示項目**:
- **修正依頼内容**: `BookingRevisionRequest.revisionNote`（全文表示）
- **依頼者**: `Client.name`
- **依頼日時**: `BookingRevisionRequest.createdAt`

**アクション**:
- **[修正対応完了]**: 再度「完了マーク」をクリック → 修正依頼を`RESOLVED`に更新 → `AWAITING_COMPLETION`のまま（利用者の再承認待ち）
- **[メッセージで確認]**: メッセージ画面へ遷移、修正内容を確認

**複数の修正依頼がある場合**:
- 最新の修正依頼のみを表示
- 過去の修正依頼はアクティビティタイムラインで確認可能

**データ構造**:
```typescript
interface BookingRevisionRequest {
  id: string;
  bookingId: string;
  requestedBy: string;  // Client ID
  revisionNote: string;
  status: 'PENDING' | 'RESOLVED' | 'REJECTED';
  createdAt: Date;
  resolvedAt: Date | null;
}
```

#### データ構造

**申込詳細API (`GET /api/bookings/:id`)**

**レスポンス**:
```typescript
interface BookingDetailResponse {
  booking: {
    id: string;
    status: BookingStatus;
    totalPrice: number;
    feeAmount: number;
    receiveAmount: number;
    paymentIntentId: string | null;
    createdAt: Date;
    updatedAt: Date;
    completedAt: Date | null;
    service: {
      id: string;
      title: string;
      description: string;
      category: ServiceCategory;
      price: number;
      imageUrl: string | null;
    };
    client: {
      id: string;
      name: string;
      profileImage: string | null;
    };
    sponsor: {
      id: string;
      name: string;
      profileImage: string | null;
      averageRating: number | null;
    };
    review: {
      id: string;
      rating: number;
      comment: string | null;
      createdAt: Date;
    } | null;
  };
  timeline: ActivityEvent[];
  recentMessages: MessagePreview[];
  conversationId: string;
  revisionRequests: BookingRevisionRequest[];  // ★新規追加：修正依頼一覧
}

interface MessagePreview {
  id: string;
  senderId: string;
  senderName: string;
  senderType: 'CLIENT' | 'SPONSOR';
  content: string;
  createdAt: Date;
}
```

#### UIコンポーネント

**使用するshadcn/uiコンポーネント**:
- `Card`: 各セクションカード
- `Button`: アクションボタン
- `Badge`: ステータスバッジ
- `Progress`: 進行バー（カスタマイズ版）
- `Separator`: セクション区切り
- `Avatar`: ユーザーアバター
- `AlertDialog`: 確認ダイアログ
- `Textarea`: メッセージ入力
- `Toast`: 操作完了通知

#### インタラクション仕様

1. **進行バーの動的更新**:
   - ステータス変更時にアニメーション付きで更新
   - 完了ステップは緑色で強調

2. **アクションボタンの動的表示**:
   - ステータスに応じて利用可能なアクションのみ表示
   - 無効なアクションはグレーアウト

3. **タイムラインの自動更新**:
   - イベント発生時にリアルタイムで追加（Socket.io）
   - 新規イベントはフェードインアニメーション

4. **メッセージのインライン送信**:
   - 送信後、メッセージ履歴に即座に反映
   - 送信中はボタンをローディング状態に

5. **決済フロー**:
   - 「決済へ進む」クリック → Stripe決済画面へ遷移
   - 決済完了後、自動的に詳細画面に戻り、ステータス更新

#### レスポンシブ対応

**モバイル（〜768px）**:
- 進行バーを縦方向に変換
- 申込情報とアクションを縦積み
- タイムラインを簡略表示

**タブレット（768px〜1024px）**:
- 2カラムレイアウト維持
- 進行バーを横方向表示

**デスクトップ（1024px〜）**:
- 全要素を横方向表示

---

### 5.11 招待コード入力ページ

```
┌─────────────────────────────────────────────────────────────┐
│                                                               │
│                                                               │
│                          HATAMO                               │
│                                                               │
│                   招待コードを入力してください                │
│                                                               │
│                                                               │
│               ┌─────────────────────────────────┐            │
│               │  招待コード                     │            │
│               │  ┌───────────────────────────┐  │            │
│               │  │   A 3 X 9 K 2 M 7         │  │            │
│               │  └───────────────────────────┘  │            │
│               │  例: A3X9K2M7                  │            │
│               │                                 │            │
│               │  [検証中の場合]                 │            │
│               │  ⟳ 確認中...                    │            │
│               │                                 │            │
│               │  [エラーの場合]                 │            │
│               │  ⚠ 招待コードが無効です         │            │
│               │  ⚠ 有効期限が切れています       │            │
│               │  ⚠ 既に使用されています         │            │
│               │                                 │            │
│               │  [成功の場合]                   │            │
│               │  ✓ 招待コードが確認されました   │            │
│               │  登録タイプ: 利用者             │            │
│               │                                 │            │
│               │  ┌───────────────────────────┐  │            │
│               │  │        次へ               │  │            │
│               │  └───────────────────────────┘  │            │
│               │                                 │            │
│               │  招待コードをお持ちでない方は、  │            │
│               │  運営チームにお問い合わせください│            │
│               └─────────────────────────────────┘            │
│                                                               │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**パス**: `/auth/register/invite-code`

**要素説明**:

| 要素 | 説明 |
|------|------|
| ロゴ | HATAMO ロゴ（中央配置） |
| タイトル | 「招待コードを入力してください」 |
| 招待コード入力欄 | 8文字の英数字入力フィールド（大文字変換、中央揃え、等幅フォント） |
| プレースホルダー | 「例: A3X9K2M7」 |
| エラーメッセージ | バリデーションエラー表示エリア（赤色） |
| 成功メッセージ | 検証成功メッセージ表示エリア（青色） |
| ユーザータイプ表示 | CLIENT（利用者）/ SPONSOR（パートナー）の判定結果 |
| 次へボタン | 検証後、登録ページへ遷移 |
| 補足テキスト | 招待コード未保有者への案内 |

**インタラクション**:

1. **入力時**:
   - 自動的に大文字変換
   - 8文字を超える入力を制限
   - エラーメッセージをクリア

2. **検証ボタンクリック時**:
   - フロントエンドバリデーション（8文字英数字チェック）
   - API呼び出しで招待コード検証
   - ローディング状態表示（ボタン無効化、スピナー表示）

3. **検証成功時**:
   - 成功メッセージ表示
   - ユーザータイプ表示（CLIENT / SPONSOR）
   - 1秒後に該当登録ページへ自動リダイレクト
     - CLIENT → `/auth/register/client?code={招待コード}`
     - SPONSOR → `/auth/register/sponsor?code={招待コード}`

4. **検証失敗時**:
   - エラーメッセージ表示
   - 入力フィールドを赤枠表示
   - ボタンを再度有効化

**API連携**:

```typescript
// リクエスト
POST /api/auth/verify-invite-code
Content-Type: application/json

{
  "code": "A3X9K2M7"
}

// レスポンス（成功）
200 OK
{
  "success": true,
  "userType": "CLIENT", // or "SPONSOR"
  "message": "招待コードが確認されました"
}

// レスポンス（エラー）
400 Bad Request
{
  "success": false,
  "message": "招待コードが無効です" // or "有効期限が切れています" or "既に使用されています"
}
```

**バリデーションルール**:

| ルール | 説明 |
|--------|------|
| 必須 | 招待コードは必須入力 |
| フォーマット | 英数字8文字（A-Z, 0-9） |
| 大文字変換 | 入力は自動的に大文字に変換 |
| 存在確認 | データベースに存在すること |
| ステータス | ACTIVE であること（USED, EXPIRED, DISABLED は不可） |
| 有効期限 | 有効期限内であること（NULL の場合は無期限） |

**エラーメッセージ**:

| エラー | メッセージ |
|--------|-----------|
| 未入力 | 「招待コードを入力してください」 |
| フォーマット不正 | 「招待コードは8文字の英数字で入力してください」 |
| コード不存在 | 「招待コードが無効です」 |
| 既に使用済み | 「この招待コードは既に使用されています」 |
| 有効期限切れ | 「招待コードの有効期限が切れています」 |
| 無効化済み | 「招待コードが無効です」 |
| API接続エラー | 「招待コードの検証に失敗しました」 |

**レスポンシブ対応**:

**モバイル（〜768px）**:
- カードの横幅を画面幅の90%に調整
- パディングを縮小（16px → 12px）
- フォントサイズを調整（タイトル: 24px → 20px）

**タブレット（768px〜1024px）**:
- カードの最大幅を500pxに設定
- 中央配置を維持

**デスクトップ（1024px〜）**:
- カードの最大幅を512pxに設定
- 十分な余白を確保

**アクセシビリティ**:

- `aria-invalid` 属性でエラー状態を示す
- エラーメッセージに `role="alert"` を付与
- キーボード操作対応（Enter キーで検証実行）
- フォーカス状態の視覚的フィードバック
- スクリーンリーダー対応のラベル

**実装ファイル**:

- `/frontend/src/app/auth/register/invite-code/page.tsx` - 招待コード入力ページ
- `/frontend/src/app/auth/register/client/page.tsx` - CLIENT登録ページ（プレースホルダー）
- `/frontend/src/app/auth/register/sponsor/page.tsx` - SPONSOR登録ページ（プレースホルダー）

**技術仕様**:

- Next.js 15 App Router
- shadcn/ui コンポーネント（Card, Input, Button, Label）
- Tailwind CSS
- React Hook Form（将来的に導入予定）
- Zod（バリデーションスキーマ）（将来的に導入予定）

### 5.12 サービス申込ページ

```
┌─────────────────────────────────────────────────────────────┐
│ HATAMO Logo              Search Box               [Profile] │
├─────────────────────────────────────────────────────────────┤
│ Home > サービス一覧 > Webサイト制作 > 申込                  │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  サービス申込                                                 │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━            │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Step 1: 申込情報  →  Step 2: 決済  →  Step 3: 完了  │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌───────────────────────────────┬─────────────────────────┐│
│  │ 申込フォーム                  │ サービス情報サマリー    ││
│  ├───────────────────────────────┤ ┌─────────────────────┐ ││
│  │                               │ │ [サービス画像]      │ ││
│  │ 申込者情報                    │ │ 320x180             │ ││
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ └─────────────────────┘ ││
│  │                               │                         ││
│  │ 氏名 *                        │ Webサイト制作           ││
│  │ ┌───────────────────────────┐│ ★★★★★ 4.8 (24件)    ││
│  │ │ 田中太郎                  ││                         ││
│  │ └───────────────────────────┘│ 提供者: 佐藤花子        ││
│  │                               │ [Avatar] ★★★★☆ 4.5    ││
│  │ メールアドレス *              │                         ││
│  │ ┌───────────────────────────┐│ ─────────────────────   ││
│  │ │ tanaka@example.com        ││ 料金詳細                ││
│  │ └───────────────────────────┘│ ━━━━━━━━━━━━━━━━━━━   ││
│  │                               │                         ││
│  │ 電話番号                      │ サービス基本料金        ││
│  │ ┌───────────────────────────┐│ ¥50,000                 ││
│  │ │ 090-1234-5678             ││                         ││
│  │ └───────────────────────────┘│ 手数料 (30% + 運営5%)   ││
│  │                               │ ¥17,500                 ││
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━ │                         ││
│  │                               │ ─────────────────────   ││
│  │ サービス詳細                  │ 合計支払額              ││
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━ │ ¥67,500                 ││
│  │                               │ ─────────────────────   ││
│  │ 希望納期 *                    │                         ││
│  │ ┌───────────────────────────┐│ ┌─────────────────────┐ ││
│  │ │ 2025/11/01          [▼]  ││ │ [決済へ進む]        │ ││
│  │ └───────────────────────────┘│ └─────────────────────┘ ││
│  │                               │                         ││
│  │ 要望・質問事項                │                         ││
│  │ ┌───────────────────────────┐│                         ││
│  │ │                           ││                         ││
│  │ │ Webサイトのリニューアルを ││                         ││
│  │ │ 検討しています...         ││                         ││
│  │ │                           ││                         ││
│  │ │                           ││                         ││
│  │ │ (500文字まで)             ││                         ││
│  │ └───────────────────────────┘│                         ││
│  │ 残り450文字                   │                         ││
│  │                               │                         ││
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━ │                         ││
│  │                               │                         ││
│  │ 同意事項                      │                         ││
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━ │                         ││
│  │                               │                         ││
│  │ □ [利用規約]に同意する *      │                         ││
│  │ □ [プライバシーポリシー]に    │                         ││
│  │   同意する *                  │                         ││
│  │ □ [特定商取引法表記]を        │                         ││
│  │   確認しました *              │                         ││
│  │ □ [キャンセルポリシー]に      │                         ││
│  │   同意する *                  │                         ││
│  │                               │                         ││
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━ │                         ││
│  │                               │                         ││
│  │ [reCAPTCHA]                   │                         ││
│  │ ┌───────────────────────────┐│                         ││
│  │ │ ☑ 私はロボットではありません││                         ││
│  │ └───────────────────────────┘│                         ││
│  │                               │                         ││
│  │ ─────────────────────────────│                         ││
│  │                               │                         ││
│  │ [キャンセル]  [申し込む]      │                         ││
│  │                               │                         ││
│  └───────────────────────────────┴─────────────────────────┘│
│                                                               │
├─────────────────────────────────────────────────────────────┤
│ Footer: About | Terms | Privacy | Contact                    │
└─────────────────────────────────────────────────────────────┘
```

**パス**: `/client/services/:serviceId/booking`

**要素説明**:

| 要素 | 説明 |
|------|------|
| パンくずリスト | Home > サービス一覧 > サービス詳細 > 申込 |
| ページタイトル | 「サービス申込」 |
| 進捗インジケーター | Step 1: 申込情報 → Step 2: 決済 → Step 3: 完了（現在Step 1） |
| 申込フォーム | 左カラム: 申込者情報、サービス詳細、同意事項入力エリア |
| サービス情報サマリー | 右カラム: サービス概要、料金詳細、決済ボタン（固定表示） |
| サービス画像 | サムネイル表示（320x180px） |
| サービスタイトル | サービス名と評価 |
| 提供者情報 | アバター、名前、評価 |
| 料金詳細 | 基本料金、手数料、合計金額 |
| 申込者情報セクション | 氏名、メールアドレス、電話番号（必須/任意） |
| サービス詳細セクション | 希望納期、要望・質問事項 |
| 同意事項セクション | 利用規約、プライバシーポリシー、特定商取引法、キャンセルポリシー |
| reCAPTCHA | Google reCAPTCHA v2チェックボックス |
| アクションボタン | キャンセル、申し込むボタン |

**データ構造**:

```typescript
interface BookingFormData {
  // 申込者情報
  fullName: string;           // 氏名（必須）
  email: string;              // メールアドレス（必須）
  phone: string | null;       // 電話番号（任意）

  // サービス詳細
  serviceId: string;          // サービスID
  desiredDeliveryDate: Date;  // 希望納期（必須）
  requestDetails: string;     // 要望・質問事項（最大500文字）

  // 同意事項
  agreeToTerms: boolean;      // 利用規約同意（必須）
  agreeToPrivacy: boolean;    // プライバシーポリシー同意（必須）
  agreeToCommercialLaw: boolean; // 特定商取引法確認（必須）
  agreeToCancellation: boolean;  // キャンセルポリシー同意（必須）

  // reCAPTCHA
  recaptchaToken: string;     // reCAPTCHAトークン（必須）
}

interface ServiceSummary {
  id: string;
  title: string;
  thumbnailUrl: string;
  rating: number;
  reviewCount: number;
  basePrice: number;          // 基本料金
  feeRate: number;            // 手数料率（0.30 = 30%）
  platformFeeRate: number;    // 運営手数料率（0.05 = 5%）
  totalFee: number;           // 手数料合計
  totalPrice: number;         // 合計支払額
  sponsor: {
    id: string;
    name: string;
    avatarUrl: string;
    rating: number;
  };
}
```

**バリデーションルール**:

| フィールド | ルール |
|-----------|--------|
| 氏名 | 必須、1文字以上50文字以下、全角・半角対応 |
| メールアドレス | 必須、有効なメール形式、最大100文字 |
| 電話番号 | 任意、数字とハイフンのみ、10〜11桁 |
| 希望納期 | 必須、今日以降の日付、サービス提供可能期間内 |
| 要望・質問事項 | 任意、最大500文字、改行含む |
| 利用規約同意 | 必須、チェック必須 |
| プライバシーポリシー同意 | 必須、チェック必須 |
| 特定商取引法確認 | 必須、チェック必須 |
| キャンセルポリシー同意 | 必須、チェック必須 |
| reCAPTCHA | 必須、トークン検証 |

**料金計算ロジック**:

```typescript
// 手数料計算
const serviceFee = basePrice * feeRate;           // サービス手数料 = 50,000 × 0.30 = 15,000
const platformFee = basePrice * platformFeeRate;  // 運営手数料 = 50,000 × 0.05 = 2,500
const totalFee = serviceFee + platformFee;        // 合計手数料 = 17,500

// 利用者支払額（基本料金 + 手数料）
const totalPrice = basePrice + totalFee;          // 67,500

// パートナー受取額（基本料金 - サービス手数料）
const sponsorRevenue = basePrice - serviceFee;    // 35,000
```

**API仕様**:

**サービス情報取得API**:

```typescript
GET /api/client/services/:serviceId/booking-info

// レスポンス（成功）
200 OK
{
  "service": {
    "id": "srv_123456",
    "title": "Webサイト制作",
    "thumbnailUrl": "https://cdn.hatamo.jp/services/srv_123456.jpg",
    "rating": 4.8,
    "reviewCount": 24,
    "basePrice": 50000,
    "feeRate": 0.30,
    "platformFeeRate": 0.05,
    "totalFee": 17500,
    "totalPrice": 67500,
    "availableDeliveryDates": {
      "minDate": "2025-11-01",
      "maxDate": "2026-01-31"
    }
  },
  "sponsor": {
    "id": "usr_789012",
    "name": "佐藤花子",
    "avatarUrl": "https://cdn.hatamo.jp/avatars/usr_789012.jpg",
    "rating": 4.5
  }
}

// レスポンス（エラー）
404 Not Found
{
  "error": "SERVICE_NOT_FOUND",
  "message": "サービスが見つかりません"
}

400 Bad Request
{
  "error": "SERVICE_NOT_AVAILABLE",
  "message": "このサービスは現在申込を受け付けていません"
}
```

**申込作成API**:

```typescript
POST /api/client/bookings
Content-Type: application/json
Authorization: Bearer {access_token}

{
  "serviceId": "srv_123456",
  "fullName": "田中太郎",
  "email": "tanaka@example.com",
  "phone": "090-1234-5678",
  "desiredDeliveryDate": "2025-11-01",
  "requestDetails": "Webサイトのリニューアルを検討しています...",
  "agreeToTerms": true,
  "agreeToPrivacy": true,
  "agreeToCommercialLaw": true,
  "agreeToCancellation": true,
  "recaptchaToken": "03AGdBq27..."
}

// レスポンス（成功）
201 Created
{
  "booking": {
    "id": "bkg_345678",
    "serviceId": "srv_123456",
    "status": "PENDING_PAYMENT",
    "totalPrice": 67500,
    "createdAt": "2025-10-07T10:30:00Z"
  },
  "paymentUrl": "https://checkout.stripe.com/c/pay/cs_test_...",
  "message": "申込が作成されました。決済を完了してください。"
}

// レスポンス（エラー）
400 Bad Request
{
  "error": "VALIDATION_ERROR",
  "message": "入力内容に誤りがあります",
  "errors": [
    {
      "field": "email",
      "message": "有効なメールアドレスを入力してください"
    },
    {
      "field": "agreeToTerms",
      "message": "利用規約への同意が必要です"
    }
  ]
}

401 Unauthorized
{
  "error": "AUTHENTICATION_REQUIRED",
  "message": "ログインが必要です"
}

403 Forbidden
{
  "error": "RECAPTCHA_VERIFICATION_FAILED",
  "message": "reCAPTCHA認証に失敗しました"
}

409 Conflict
{
  "error": "DUPLICATE_BOOKING",
  "message": "このサービスは既に申込済みです"
}
```

**インタラクション仕様**:

1. **ページ初期表示**:
   - URLパラメータから`serviceId`を取得
   - サービス情報取得APIを呼び出し
   - サービス情報サマリーを表示
   - ログインユーザーの場合、メールアドレスを自動入力

2. **入力時バリデーション**:
   - 氏名: リアルタイムで文字数チェック
   - メールアドレス: フォーカスアウト時にフォーマット検証
   - 電話番号: 入力時に自動フォーマット（ハイフン挿入）
   - 要望・質問事項: 残り文字数をリアルタイム表示

3. **希望納期選択**:
   - DatePickerで選択
   - サービス提供可能期間内の日付のみ選択可能
   - 過去の日付は選択不可

4. **同意チェック**:
   - リンクテキストをクリックで各規約を新しいタブで表示
   - 全ての同意チェックがオンになるまで「申し込む」ボタンを無効化

5. **reCAPTCHA**:
   - Google reCAPTCHA v2チェックボックスを表示
   - トークン取得後、フォーム送信可能に

6. **申し込むボタンクリック時**:
   - フロントエンドバリデーション実行
   - エラーがあれば該当フィールドにエラーメッセージ表示
   - 検証成功で申込作成APIを呼び出し
   - ローディング状態表示（ボタン無効化、スピナー表示）

7. **申込作成成功時**:
   - Stripe決済画面へリダイレクト（`paymentUrl`）
   - 決済完了後、申込完了ページへリダイレクト

8. **申込作成失敗時**:
   - エラーメッセージをトースト通知で表示
   - フィールドエラーがあれば該当フィールドに表示
   - ボタンを再度有効化

**決済フロー詳細**:

```
1. 利用者が申込フォーム入力
   ↓
2. 「申し込む」ボタンクリック
   ↓
3. フロントエンドバリデーション
   ↓
4. 申込作成API呼び出し（POST /api/client/bookings）
   ↓
5. バックエンドで申込レコード作成（status: PENDING_PAYMENT）
   ↓
6. Stripe Checkout Sessionを作成
   ↓
7. Checkout Session URLを返す
   ↓
8. Stripe決済画面へリダイレクト
   ↓
9. 利用者がクレジットカード情報を入力
   ↓
10. 決済完了
   ↓
11. Stripe Webhookで決済完了通知受信
   ↓
12. 申込ステータスを AWAITING_APPROVAL に更新
   ↓
13. パートナーに申込通知メール送信
   ↓
14. 申込完了ページへリダイレクト（success_url）
   ↓
15. パートナーが申込を承認
   ↓
16. 申込ステータスを IN_PROGRESS に更新
   ↓
17. サービス提供開始
```

**Stripe連携仕様**:

```typescript
// Stripe Checkout Session作成
const session = await stripe.checkout.sessions.create({
  payment_method_types: ['card'],
  line_items: [
    {
      price_data: {
        currency: 'jpy',
        product_data: {
          name: service.title,
          images: [service.thumbnailUrl],
        },
        unit_amount: totalPrice, // 67500円
      },
      quantity: 1,
    },
  ],
  mode: 'payment',
  success_url: `${FRONTEND_URL}/client/bookings/${booking.id}/complete?session_id={CHECKOUT_SESSION_ID}`,
  cancel_url: `${FRONTEND_URL}/client/services/${serviceId}/booking?canceled=true`,
  metadata: {
    bookingId: booking.id,
    serviceId: service.id,
    sponsorId: sponsor.id,
  },
});
```

**エラーハンドリング**:

| エラー種別 | ハンドリング |
|-----------|-------------|
| バリデーションエラー | フィールド単位でエラーメッセージ表示 |
| 認証エラー | ログインページへリダイレクト |
| reCAPTCHA検証失敗 | トースト通知 + reCAPTCHAリセット |
| サービス取得失敗 | エラーページ表示（404 Not Found） |
| 申込作成失敗 | トースト通知 + フォーム再編集可能 |
| 決済キャンセル | 申込ページに戻る（URLパラメータ `?canceled=true`） |
| ネットワークエラー | リトライ可能なエラートースト表示 |

**レスポンシブ対応**:

**モバイル（〜768px）**:
- 1カラムレイアウトに変更
- サービス情報サマリーを上部に配置
- 申込フォームを下部に配置
- 料金詳細をアコーディオンで折りたたみ可能に
- フォントサイズ調整（16px → 14px）

**タブレット（768px〜1024px）**:
- 2カラムレイアウト維持
- カラム幅比率を6:4から7:3に調整
- 余白を適度に確保

**デスクトップ（1024px〜）**:
- 2カラムレイアウト（左60% : 右40%）
- 最大幅1280pxに制限
- サービス情報サマリーを固定表示（sticky position）
- 十分な余白を確保

**実装ファイル**:

- `/frontend/src/app/client/services/[serviceId]/booking/page.tsx` - 申込ページメインコンポーネント
- `/frontend/src/components/booking/BookingForm.tsx` - 申込フォームコンポーネント
- `/frontend/src/components/booking/ServiceSummary.tsx` - サービス情報サマリーコンポーネント
- `/frontend/src/components/booking/PriceBreakdown.tsx` - 料金詳細コンポーネント
- `/frontend/src/hooks/useBookingForm.ts` - 申込フォームロジック（React Hook）
- `/frontend/src/lib/validations/booking.ts` - バリデーションスキーマ（Zod）
- `/frontend/src/lib/api/bookings.ts` - 申込API呼び出し関数

**技術仕様**:

- Next.js 15 App Router
- React Hook Form + Zod（バリデーション）
- shadcn/ui コンポーネント（Card, Input, Button, Label, Textarea, Checkbox, Calendar）
- Tailwind CSS
- Stripe Checkout
- Google reCAPTCHA v2

**セキュリティ**:

- reCAPTCHA v2チェックボックス必須
- CSRFトークン検証
- レート制限（1ユーザーあたり1分間に3回まで）
- XSS対策（入力値のエスケープ）
- SQLインジェクション対策（Prisma ORMによるパラメータバインド）

---

## 6. レスポンシブ設計
