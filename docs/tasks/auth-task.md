# HATAMO 認証機能 - タスク分解

**作成日**: 2025年10月18日
**参照元**: [docs/auth-fllow.md](../auth-fllow.md)
**バージョン**: v1.0

---

## 📋 タスク概要

認証フロー（新規登録・ログイン・メール確認）の実装タスクをフロントエンドとバックエンドに分けて管理します。

---

## 🎨 フロントエンド (Frontend)

### Phase 1: 招待コード入力・検証

#### F-1. 招待コード入力ページ実装
**ページ**: `/auth/register/invite-code`

- [x] **F-1.1** ページコンポーネント作成 (`/frontend/src/app/auth/register/invite-code/page.tsx`) ✅ 実装済み
- [x] **F-1.2** 招待コードフォームコンポーネント作成 ✅ 実装済み
  - フロントエンドバリデーション（英数字8文字）
  - 自動大文字変換
- [x] **F-1.3** Figma デザインに基づくUI実装 ✅ 実装済み
- [x] **F-1.4** ローディング状態の実装 ✅ 実装済み
- [x] **F-1.5** エラー表示UI実装 ✅ 実装済み
- [ ] **F-1.6** バックエンドAPIとの連携（残タスク）
  - API呼び出し (`POST /api/auth/verify-invite-code`)
  - 成功時: ユーザータイプに応じた登録ページへ遷移
  - 失敗時: エラーメッセージ表示
  - **現状**: フロントエンド実装済み（50-86行目）、APIエンドポイントの実装待ち

---

### Phase 2: 新規登録ページ実装

#### F-2. CLIENT登録ページ実装
**ページ**: `/auth/register/client`

- [ ] **F-2.1** ページコンポーネント作成 (`/frontend/src/app/auth/register/client/page.tsx`)
- [ ] **F-2.2** 登録フォームコンポーネント作成
  - 氏名（姓・名）
  - メールアドレス
  - パスワード
  - パスワード（確認）
- [ ] **F-2.3** バリデーション実装 (react-hook-form + zod)
  - メール形式チェック
  - パスワード強度チェック（8文字以上など）
  - パスワード一致確認
- [ ] **F-2.4** Figma デザインに基づくUI実装
- [ ] **F-2.5** アクセス制御実装
  - 招待コード未検証の場合: `/auth/register/invite-code` へリダイレクト
  - 招待コードのユーザータイプが SPONSOR の場合: `/auth/register/sponsor` へリダイレクト
- [ ] **F-2.6** 登録API呼び出し (`/api/auth/register/client`)
- [ ] **F-2.7** 成功時: `/auth/register/complete` へ遷移

#### F-3. SPONSOR登録ページ実装
**ページ**: `/auth/register/sponsor`

- [ ] **F-3.1** ページコンポーネント作成 (`/frontend/src/app/auth/register/sponsor/page.tsx`)
- [ ] **F-3.2** 登録フォームコンポーネント作成
  - 屋号（店舗名・企業名）
  - 担当者名（姓・名）
  - メールアドレス
  - パスワード
  - パスワード（確認）
  - 事業内容（任意）
- [ ] **F-3.3** バリデーション実装 (react-hook-form + zod)
- [ ] **F-3.4** Figma デザインに基づくUI実装
- [ ] **F-3.5** アクセス制御実装
  - 招待コード未検証の場合: `/auth/register/invite-code` へリダイレクト
  - 招待コードのユーザータイプが CLIENT の場合: `/auth/register/client` へリダイレクト
- [ ] **F-3.6** 登録API呼び出し (`/api/auth/register/sponsor`)
- [ ] **F-3.7** 成功時: `/auth/register/complete` へ遷移

---

### Phase 3: 登録完了・メール確認

#### F-4. 登録完了ページ実装
**ページ**: `/auth/register/complete`

- [ ] **F-4.1** ページコンポーネント作成 (`/frontend/src/app/auth/register/complete/page.tsx`)
- [ ] **F-4.2** 登録完了メッセージ表示
- [ ] **F-4.3** 確認メール送信案内表示
- [ ] **F-4.4** Figma デザインに基づくUI実装

#### F-5. メール確認ページ実装
**ページ**: `/auth/verify-email?token=xxx`

- [ ] **F-5.1** ページコンポーネント作成 (`/frontend/src/app/auth/verify-email/page.tsx`)
- [ ] **F-5.2** URLパラメータからトークン取得
- [ ] **F-5.3** メール確認API呼び出し (`/api/auth/verify-email`)
- [ ] **F-5.4** ローディング状態の表示
- [ ] **F-5.5** 成功時の処理
  - 自動ログイン
  - トークンをCookieに保存
  - `/` (サービス一覧ページ) へリダイレクト
- [ ] **F-5.6** 失敗時のエラー表示
  - トークン無効
  - トークン期限切れ

---

### Phase 4: ログイン

#### F-6. ログインページ実装
**ページ**: `/auth/login`

- [ ] **F-6.1** ページコンポーネント作成 (`/frontend/src/app/auth/login/page.tsx`)
- [ ] **F-6.2** ログインフォームコンポーネント作成
  - メールアドレス
  - パスワード
- [ ] **F-6.3** バリデーション実装 (react-hook-form + zod)
- [ ] **F-6.4** Figma デザインに基づくUI実装
- [ ] **F-6.5** ログインAPI呼び出し (`/api/auth/login`)
- [ ] **F-6.6** 成功時: トークンをCookieに保存し `/` へリダイレクト
- [ ] **F-6.7** 失敗時: エラーメッセージ表示（「メールアドレスまたはパスワードが間違っています」）

---

### Phase 5: 認証制御・Middleware

#### F-7. Next.js Middleware 実装
**ファイル**: `/frontend/src/middleware.ts`

- [ ] **F-7.1** 認証状態チェック機能実装
  - CookieからJWTトークン取得
  - トークンの検証
- [ ] **F-7.2** 未認証ユーザーのアクセス制御
  - 認証必須ページへのアクセス → `/auth/login` へリダイレクト
  - 公開ページ: `/`, `/auth/*` はアクセス許可
- [ ] **F-7.3** 認証済みユーザーのアクセス制御
  - `/client/*` は CLIENT のみアクセス可能
  - `/sponsor/*` は SPONSOR のみアクセス可能
  - 不正アクセス → `/` へリダイレクト
- [ ] **F-7.4** メール未確認ユーザーへのバナー表示制御

#### F-8. 認証状態管理 (Zustand)

- [ ] **F-8.1** 認証ストア作成 (`/frontend/src/store/authStore.ts`)
  - ユーザー情報 (id, email, userType, emailVerified)
  - ログイン状態
  - 招待コード情報（一時保存）
- [ ] **F-8.2** ログイン/ログアウトアクション実装
- [ ] **F-8.3** 招待コード保存/取得アクション実装

---

### Phase 6: UI/UX 改善

#### F-9. 共通コンポーネント

- [ ] **F-9.1** メール未確認バナーコンポーネント作成
- [ ] **F-9.2** トースト通知コンポーネント作成（成功/エラー）
- [ ] **F-9.3** ローディングスピナーコンポーネント作成
- [ ] **F-9.4** フォーム共通スタイル整備

#### F-10. レスポンシブ対応

- [ ] **F-10.1** スマートフォン表示対応（〜767px）
- [ ] **F-10.2** デスクトップ表示対応（768px〜）
- [ ] **F-10.3** Tailwind CSS でブレークポイント実装 (`md:`)

---

## 🔧 バックエンド (Backend)

### Phase 1: 招待コード検証API

#### B-1. 招待コード検証エンドポイント
**API**: `POST /api/auth/verify-invite-code`

- [ ] **B-1.1** ルーティング設定 (`/backend/src/routes/auth.routes.ts`)
- [ ] **B-1.2** コントローラー作成 (`/backend/src/controllers/auth.controller.ts`)
- [ ] **B-1.3** サービス層作成 (`/backend/src/services/auth.service.ts`)
- [ ] **B-1.4** バリデーション実装
  - リクエストボディの形式チェック (zod)
- [ ] **B-1.5** ビジネスロジック実装
  - 招待コードが存在するか (Prisma クエリ)
  - 有効期限内か (`expiresAt` チェック)
  - ステータスが `ACTIVE` か
  - 使用回数制限に達していないか
- [ ] **B-1.6** レスポンス返却
  - 成功時: `{ status: 'success', data: { userType, inviteCodeId } }`
  - 失敗時: `{ status: 'error', message: 'エラーメッセージ' }`
- [ ] **B-1.7** エラーハンドリング実装

---

### Phase 2: 新規登録API

#### B-2. CLIENT登録エンドポイント
**API**: `POST /api/auth/register/client`

- [ ] **B-2.1** ルーティング設定
- [ ] **B-2.2** コントローラー作成
- [ ] **B-2.3** サービス層作成
- [ ] **B-2.4** バリデーション実装
  - 氏名、メールアドレス、パスワードの形式チェック
  - パスワード強度チェック
- [ ] **B-2.5** ビジネスロジック実装
  - メールアドレス重複チェック
  - パスワードのハッシュ化 (bcrypt)
  - ユーザー作成 (Prisma)
  - 招待コードの `usedBy` 更新
  - 招待コードのステータス更新 (必要に応じて `USED`)
- [ ] **B-2.6** メール確認トークン生成
  - EmailVerificationToken テーブルに保存
  - 有効期限: 24時間
- [ ] **B-2.7** 確認メール送信トリガー
- [ ] **B-2.8** レスポンス返却
- [ ] **B-2.9** トランザクション処理実装

#### B-3. SPONSOR登録エンドポイント
**API**: `POST /api/auth/register/sponsor`

- [ ] **B-3.1** ルーティング設定
- [ ] **B-3.2** コントローラー作成
- [ ] **B-3.3** サービス層作成
- [ ] **B-3.4** バリデーション実装
  - 屋号、担当者名、メールアドレス、パスワードの形式チェック
- [ ] **B-3.5** ビジネスロジック実装
  - メールアドレス重複チェック
  - パスワードのハッシュ化 (bcrypt)
  - ユーザー作成 (Prisma)
  - 招待コードの `usedBy` 更新
  - 招待コードのステータス更新
- [ ] **B-3.6** メール確認トークン生成
- [ ] **B-3.7** 確認メール送信トリガー
- [ ] **B-3.8** レスポンス返却
- [ ] **B-3.9** トランザクション処理実装

---

### Phase 3: メール確認

#### B-4. 確認メール送信機能
**API**: `POST /api/auth/send-verification-email`

- [ ] **B-4.1** メール送信サービス作成 (`/backend/src/services/email.service.ts`)
- [ ] **B-4.2** SMTP設定 (環境変数)
- [ ] **B-4.3** メールテンプレート作成
  - 件名: 【HATAMO】メールアドレスの確認
  - 本文: 確認リンク含む
- [ ] **B-4.4** メール送信ロジック実装
- [ ] **B-4.5** エラーハンドリング（送信失敗時）

#### B-5. メール確認エンドポイント
**API**: `GET /api/auth/verify-email?token=xxx`

- [ ] **B-5.1** ルーティング設定
- [ ] **B-5.2** コントローラー作成
- [ ] **B-5.3** サービス層作成
- [ ] **B-5.4** トークン検証ロジック実装
  - トークンの存在チェック (Prisma)
  - トークンの有効期限チェック (24時間以内)
  - トークンの未使用チェック
- [ ] **B-5.5** ユーザー更新処理
  - `emailVerified` を `true` に更新
  - トークンを使用済みに更新
- [ ] **B-5.6** JWT トークン発行（自動ログイン用）
- [ ] **B-5.7** レスポンス返却
  - 成功時: JWT トークン
  - 失敗時: エラーメッセージ
- [ ] **B-5.8** トランザクション処理実装

---

### Phase 4: ログイン

#### B-6. ログインエンドポイント
**API**: `POST /api/auth/login`

- [ ] **B-6.1** ルーティング設定
- [ ] **B-6.2** コントローラー作成
- [ ] **B-6.3** サービス層作成
- [ ] **B-6.4** バリデーション実装
  - メールアドレス、パスワードの形式チェック
- [ ] **B-6.5** 認証ロジック実装
  - メールアドレスでユーザー検索 (Prisma)
  - パスワード検証 (bcrypt.compare)
- [ ] **B-6.6** JWT トークン発行
  - ペイロード: { userId, userType, emailVerified }
  - 有効期限: 7日
  - 署名: JWT_SECRET
- [ ] **B-6.7** レスポンス返却
  - 成功時: JWT トークン、ユーザー情報
  - 失敗時: 「メールアドレスまたはパスワードが間違っています」
- [ ] **B-6.8** エラーハンドリング実装

---

### Phase 5: 認証ミドルウェア

#### B-7. JWT認証ミドルウェア
**ファイル**: `/backend/src/middlewares/auth.middleware.ts`

- [ ] **B-7.1** JWT検証ミドルウェア作成
  - リクエストヘッダーまたはCookieからトークン取得
  - トークンの検証 (jwt.verify)
  - ペイロードをリクエストオブジェクトに格納 (`req.user`)
- [ ] **B-7.2** ユーザータイプチェックミドルウェア作成
  - CLIENT専用エンドポイント保護
  - SPONSOR専用エンドポイント保護
- [ ] **B-7.3** メール確認済みチェックミドルウェア作成
- [ ] **B-7.4** エラーハンドリング
  - トークン無効: 401 Unauthorized
  - トークン期限切れ: 401 Unauthorized

---

### Phase 6: セキュリティ・その他

#### B-8. セキュリティ実装

- [ ] **B-8.1** CSRF対策実装 (`csurf` ミドルウェア)
- [ ] **B-8.2** レート制限実装 (`express-rate-limit`)
  - ログインAPI: 15分間に5回まで
  - 登録API: 15分間に3回まで
- [ ] **B-8.3** CORS設定
- [ ] **B-8.4** Helmet.js 導入（セキュリティヘッダー）
- [ ] **B-8.5** 環境変数の検証（起動時チェック）

#### B-9. エラーハンドリング

- [ ] **B-9.1** 統一エラーハンドリングミドルウェア作成
- [ ] **B-9.2** カスタムエラークラス作成 (`AppError`)
- [ ] **B-9.3** Prismaエラーハンドリング
  - 一意制約違反 (P2002)
  - レコード未検出 (P2025)
- [ ] **B-9.4** ログ出力実装 (Winston)

#### B-10. バリデーション

- [ ] **B-10.1** Zod スキーマ定義 (`/backend/src/validators/`)
  - 招待コード検証スキーマ
  - CLIENT登録スキーマ
  - SPONSOR登録スキーマ
  - ログインスキーマ
- [ ] **B-10.2** バリデーションミドルウェア作成

---

## 🧪 テスト

### フロントエンド

- [ ] **T-F-1** 招待コード入力フォームの単体テスト
- [ ] **T-F-2** CLIENT登録フォームの単体テスト
- [ ] **T-F-3** SPONSOR登録フォームの単体テスト
- [ ] **T-F-4** ログインフォームの単体テスト
- [ ] **T-F-5** Middleware のアクセス制御テスト
- [ ] **T-F-6** 認証ストアの単体テスト
- [ ] **T-F-7** E2Eテスト (Playwright)
  - 新規登録フロー全体
  - ログインフロー全体
  - メール確認フロー

### バックエンド

- [ ] **T-B-1** 招待コード検証APIの単体テスト
- [ ] **T-B-2** CLIENT登録APIの単体テスト
- [ ] **T-B-3** SPONSOR登録APIの単体テスト
- [ ] **T-B-4** メール確認APIの単体テスト
- [ ] **T-B-5** ログインAPIの単体テスト
- [ ] **T-B-6** JWT認証ミドルウェアの単体テスト
- [ ] **T-B-7** バリデーションのテスト
- [ ] **T-B-8** エラーハンドリングのテスト
- [ ] **T-B-9** 統合テスト (Supertest)
  - 新規登録フロー全体
  - ログインフロー全体

---

## 📝 補足事項

### 実装順序の推奨

1. **B-1** → **F-1.6**: 招待コード検証機能（フロントエンド実装済み、API連携のみ）
2. **B-2, B-3** → **F-2, F-3**: 新規登録機能
3. **B-4, B-5** → **F-5**: メール確認機能
4. **B-6** → **F-6**: ログイン機能
5. **B-7** → **F-7**: 認証ミドルウェア
6. **B-8, B-9**: セキュリティ強化
7. **T-F-*, T-B-***: テスト実装

### 実装状況

#### 完了済み
- ✅ **F-1.1~F-1.5**: 招待コード入力ページ（UI・バリデーション・ローディング・エラー表示）

#### 進行中
- 🔄 **F-1.6**: バックエンドAPI連携（B-1完了後に実装）

### 依存関係

- フロントエンドタスクは対応するバックエンドAPIの完成後に実装可能
- Middleware (F-7) は全API実装後に統合テスト
- セキュリティ機能 (B-8) は並行して実装可能

### 環境変数

以下の環境変数が必要:
```bash
# JWT
JWT_SECRET="your-secret-key"
JWT_EXPIRES_IN="7d"

# Email (SMTP)
SMTP_HOST="smtp.example.com"
SMTP_PORT="587"
SMTP_USER="your-email@example.com"
SMTP_PASS="your-password"

# Frontend URL
FRONTEND_URL="http://localhost:3000"
```

---

**次のステップ**: 各タスクを順次実装し、チェックボックスを更新していきます。
