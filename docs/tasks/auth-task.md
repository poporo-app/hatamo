# HATAMO 認証機能 - タスク分解

**作成日**: 2025年10月18日
**参照元**: [docs/auth-fllow.md](../auth-fllow.md)
**バージョン**: v1.0

---

## 📋 タスク概要

認証フロー（新規登録・ログイン・メール確認）の実装タスクをフロントエンドとバックエンドに分けて管理します。

---

## 🎨 フロントエンド (Frontend)

### Phase 1: 招待コード入力・検証

#### F-1. 招待コード入力ページ実装
**ページ**: `/auth/register/invite-code`

- [x] **F-1.1** ページコンポーネント作成 (`/frontend/src/app/auth/register/invite-code/page.tsx`) ✅ 実装済み
- [x] **F-1.2** 招待コードフォームコンポーネント作成 ✅ 実装済み
  - フロントエンドバリデーション（英数字8文字）
  - 自動大文字変換
- [x] **F-1.3** Figma デザインに基づくUI実装 ✅ 実装済み
- [x] **F-1.4** ローディング状態の実装 ✅ 実装済み
- [x] **F-1.5** エラー表示UI実装 ✅ 実装済み
- [ ] **F-1.6** レスポンシブ対応実装
  - スマートフォン表示（〜767px）: 画面幅いっぱいのフォーム、タップしやすいボタンサイズ
  - デスクトップ表示（768px〜）: 中央配置、最大幅制限
  - Tailwind CSS ブレークポイント (`md:`) を使用
- [ ] **F-1.7** バックエンドAPIとの連携（残タスク）
  - API呼び出し (`POST /api/auth/verify-invite-code`)
  - 成功時: ユーザータイプに応じた登録ページへ遷移
  - 失敗時: エラーメッセージ表示
  - **現状**: フロントエンド実装済み（50-86行目）、APIエンドポイントの実装待ち

---

### Phase 2: 新規登録ページ実装

#### F-2. CLIENT登録ページ実装
**ページ**: `/auth/register/client`

- [x] **F-2.1** ページコンポーネント作成 (`/frontend/src/app/auth/register/client/page.tsx`) ✅ 実装済み (2025-10-18)
- [x] **F-2.2** 登録フォームコンポーネント作成 ✅ 実装済み (2025-10-18)
  - 氏名（姓・名）- 2つのフィールドに分割実装
  - メールアドレス
  - パスワード
  - パスワード（確認）
  - プロフィール画像（任意）
- [x] **F-2.3** バリデーション実装 (react-hook-form + zod) ✅ 実装済み (2025-10-18)
  - メール形式チェック
  - パスワード強度チェック（8文字以上）
  - パスワード一致確認
  - 利用規約・プライバシーポリシー同意チェック
  - reCAPTCHA風チェックボックス
- [x] **F-2.4** Figma デザインに基づくUI実装 ✅ 実装済み (2025-10-18)
  - 招待コード入力ページと統一されたデザイン
  - 緑色のボックスで招待コード表示
  - 青色のボックスで登録タイプ表示
- [x] **F-2.5** レスポンシブ対応実装 ✅ 実装済み (2025-10-18)
  - スマートフォン表示（〜767px）: 縦スクロール、フォームフィールドのスタック配置
  - デスクトップ表示（768px〜）: 2カラムレイアウト（姓・名並列）
  - Tailwind CSS ブレークポイント (`md:`) を使用
- [x] **F-2.6** アクセス制御実装 ✅ 実装済み (2025-10-18)
  - 招待コード未検証の場合: `/auth/register/invite-code` へリダイレクト (useEffect実装)
- [x] **F-2.7** 登録API呼び出し (`/api/auth/register/client`) ✅ 実装済み (2025-10-18)
  - FormData形式でPOSTリクエスト送信
  - エラーハンドリング実装
- [x] **F-2.8** 成功時: `/auth/register/complete` へ遷移 ✅ 実装済み (2025-10-18)

#### F-3. SPONSOR登録ページ実装
**ページ**: `/auth/register/sponsor`

- [x] **F-3.1** ページコンポーネント作成 (`/frontend/src/app/auth/register/sponsor/page.tsx`) ✅ 実装済み (2025-10-18)
- [x] **F-3.2** 登録フォームコンポーネント作成 ✅ 実装済み (2025-10-18)
  - 屋号（店舗名・企業名）
  - 担当者名（姓・名）- 2つのフィールドに分割実装
  - メールアドレス
  - パスワード
  - パスワード（確認）
  - 事業内容（任意）- textareaで実装
- [x] **F-3.3** バリデーション実装 (react-hook-form + zod) ✅ 実装済み (2025-10-18)
  - 全必須フィールドのバリデーション
  - メール形式チェック
  - パスワード強度チェック（8文字以上）
  - パスワード一致確認
  - 利用規約・プライバシーポリシー同意チェック
  - reCAPTCHA風チェックボックス
- [x] **F-3.4** Figma デザインに基づくUI実装 ✅ 実装済み (2025-10-18)
  - CLIENT登録ページと統一されたデザイン
  - 緑色のボックスで招待コード表示
  - 青色のボックスで登録タイプ表示
- [x] **F-3.5** レスポンシブ対応実装 ✅ 実装済み (2025-10-18)
  - スマートフォン表示（〜767px）: 縦スクロール、フォームフィールドのスタック配置
  - デスクトップ表示（768px〜）: 2カラムレイアウト（担当者名姓・名並列）
  - Tailwind CSS ブレークポイント (`md:`) を使用
- [x] **F-3.6** アクセス制御実装 ✅ 実装済み (2025-10-18)
  - 招待コード未検証の場合: `/auth/register/invite-code` へリダイレクト (useEffect実装)
- [x] **F-3.7** 登録API呼び出し (`/api/auth/register/sponsor`) ✅ 実装済み (2025-10-18)
  - JSON形式でPOSTリクエスト送信
  - エラーハンドリング実装
- [x] **F-3.8** 成功時: `/auth/register/complete` へ遷移 ✅ 実装済み (2025-10-18)

---

### Phase 3: 登録完了・メール確認

#### F-4. 登録完了ページ実装
**ページ**: `/auth/register/complete`

- [x] **F-4.1** ページコンポーネント作成 (`/frontend/src/app/auth/register/complete/page.tsx`) ✅ 実装済み (2025-10-18)
- [x] **F-4.2** 登録完了メッセージ表示 ✅ 実装済み (2025-10-18)
  - 成功アイコン（緑色のチェックマーク）表示
  - 確認メール送信通知（青色のボックス）
  - 次のステップ案内（グレーのボックス）
- [x] **F-4.3** 確認メール送信案内表示 ✅ 実装済み (2025-10-18)
  - メールが届かない場合の案内（黄色のボックス）
  - 確認メール再送信ボタン実装
- [x] **F-4.4** Figma デザインに基づくUI実装 ✅ 実装済み (2025-10-18)
  - 他の認証ページと統一されたデザイン（gradient背景、白いカード）
  - HATAMO ロゴ配置
- [x] **F-4.5** レスポンシブ対応実装 ✅ 実装済み (2025-10-18)
  - スマートフォン表示（〜767px）: テキスト中央配置、適切な余白
  - デスクトップ表示（768px〜）: カード型レイアウト（max-w-[448px]）、中央配置
  - Tailwind CSS ブレークポイント使用
- [x] **F-4.6** Suspense対応実装 ✅ 実装済み (2025-10-18)
  - useSearchParams使用時のHydration対策
  - Client-side mount detection パターン実装

#### F-5. メール確認ページ実装
**ページ**: `/auth/verify-email?token=xxx`

- [x] **F-5.1** ページコンポーネント作成 (`/frontend/src/app/auth/verify-email/page.tsx`) ✅ 実装済み (2025-10-18)
- [x] **F-5.2** URLパラメータからトークン取得 ✅ 実装済み (2025-10-18)
  - useSearchParams + Suspense でHydration対策
  - Client-side mount detection パターン実装
- [x] **F-5.3** メール確認API呼び出し (`/api/auth/verify-email`) ✅ 実装済み (2025-10-18)
  - GET `/api/auth/verify-email?token=xxx` へリクエスト
  - エラーハンドリング実装
- [x] **F-5.4** ローディング状態の表示 ✅ 実装済み (2025-10-18)
  - スピナーアイコン表示
  - 「メールアドレスを確認中...」メッセージ
- [x] **F-5.5** 成功時の処理 ✅ 実装済み (2025-10-18)
  - 成功アイコン（緑色のチェックマーク）表示
  - 自動ログイン（バックエンドがSet-Cookieヘッダーでトークン設定）
  - 2秒後に `/` (サービス一覧ページ) へ自動リダイレクト
- [x] **F-5.6** 失敗時のエラー表示 ✅ 実装済み (2025-10-18)
  - エラーアイコン（赤色の警告マーク）表示
  - トークン無効・期限切れの詳細エラーメッセージ
  - 考えられる原因の表示（黄色のボックス）
  - 確認メール再送信リンク
  - ログイン画面へのリンク
- [x] **F-5.7** レスポンシブ対応実装 ✅ 実装済み (2025-10-18)
  - スマートフォン表示（〜767px）: シンプルなメッセージ表示、縦スクロール
  - デスクトップ表示（768px〜）: カード型レイアウト（max-w-[448px]）、中央配置
  - Tailwind CSS ブレークポイント使用

---

### Phase 4: ログイン

#### F-6. ログインページ実装
**ページ**: `/auth/login`

- [ ] **F-6.1** ページコンポーネント作成 (`/frontend/src/app/auth/login/page.tsx`)
- [ ] **F-6.2** ログインフォームコンポーネント作成
  - メールアドレス
  - パスワード
- [ ] **F-6.3** バリデーション実装 (react-hook-form + zod)
- [ ] **F-6.4** Figma デザインに基づくUI実装
- [ ] **F-6.5** レスポンシブ対応実装
  - スマートフォン表示（〜767px）: 画面幅いっぱいのフォーム、タップしやすいボタン
  - デスクトップ表示（768px〜）: 中央配置、最大幅制限
  - Tailwind CSS ブレークポイント (`md:`) を使用
- [ ] **F-6.6** ログインAPI呼び出し (`/api/auth/login`)
- [ ] **F-6.7** 成功時: トークンをCookieに保存し `/` へリダイレクト
- [ ] **F-6.8** 失敗時: エラーメッセージ表示（「メールアドレスまたはパスワードが間違っています」）

---

### Phase 5: 認証制御・Middleware

#### F-7. Next.js Middleware 実装
**ファイル**: `/frontend/src/middleware.ts`

- [ ] **F-7.1** 認証状態チェック機能実装
  - CookieからJWTトークン取得
  - トークンの検証
- [ ] **F-7.2** 未認証ユーザーのアクセス制御
  - 認証必須ページへのアクセス → `/auth/login` へリダイレクト
  - 公開ページ: `/`, `/auth/*` はアクセス許可
- [ ] **F-7.3** 認証済みユーザーのアクセス制御
  - `/client/*` は CLIENT のみアクセス可能
  - `/sponsor/*` は SPONSOR のみアクセス可能
  - 不正アクセス → `/` へリダイレクト
- [ ] **F-7.4** メール未確認ユーザーへのバナー表示制御

#### F-8. 認証状態管理 (Zustand)

- [ ] **F-8.1** 認証ストア作成 (`/frontend/src/store/authStore.ts`)
  - ユーザー情報 (id, email, userType, emailVerified)
  - ログイン状態
  - 招待コード情報（一時保存）
- [ ] **F-8.2** ログイン/ログアウトアクション実装
- [ ] **F-8.3** 招待コード保存/取得アクション実装

---

### Phase 6: UI/UX 改善

#### F-9. 共通コンポーネント

- [ ] **F-9.1** メール未確認バナーコンポーネント作成
  - レスポンシブ対応（スマートフォン: スタック表示、デスクトップ: 横並び）
- [ ] **F-9.2** トースト通知コンポーネント作成（成功/エラー）
  - レスポンシブ対応（画面サイズに応じた配置とサイズ調整）
- [ ] **F-9.3** ローディングスピナーコンポーネント作成
  - レスポンシブ対応（画面サイズに応じたサイズ調整）
- [ ] **F-9.4** フォーム共通スタイル整備
  - レスポンシブ対応（スマートフォン: フルウィドス、デスクトップ: 適切な幅制限）

---

## 🔧 バックエンド (Backend)

### Phase 1: 招待コード検証API

#### B-1. 招待コード検証エンドポイント
**API**: `POST /api/auth/verify-invite-code`

- [ ] **B-1.1** ルーティング設定 (`/backend/src/routes/auth.routes.ts`)
- [ ] **B-1.2** コントローラー作成 (`/backend/src/controllers/auth.controller.ts`)
- [ ] **B-1.3** サービス層作成 (`/backend/src/services/auth.service.ts`)
- [ ] **B-1.4** バリデーション実装
  - リクエストボディの形式チェック (zod)
- [ ] **B-1.5** ビジネスロジック実装
  - 招待コードが存在するか (Prisma クエリ)
  - 有効期限内か (`expiresAt` チェック)
  - ステータスが `ACTIVE` か
  - 使用回数制限に達していないか
- [ ] **B-1.6** レスポンス返却
  - 成功時: `{ status: 'success', data: { userType, inviteCodeId } }`
  - 失敗時: `{ status: 'error', message: 'エラーメッセージ' }`
- [ ] **B-1.7** エラーハンドリング実装

---

### Phase 2: 新規登録API

#### B-2. CLIENT登録エンドポイント
**API**: `POST /api/auth/register/client`

- [x] **B-2.1** ルーティング設定 ✅
- [x] **B-2.2** コントローラー作成 ✅
- [x] **B-2.3** サービス層作成 ✅
- [x] **B-2.4** バリデーション実装 ✅
  - 氏名、メールアドレス、パスワードの形式チェック
  - パスワード強度チェック
- [x] **B-2.5** ビジネスロジック実装 ✅
  - メールアドレス重複チェック
  - パスワードのハッシュ化 (bcrypt)
  - ユーザー作成 (Prisma)
  - 招待コードの `usedBy` 更新
  - 招待コードのステータス更新 (必要に応じて `USED`)
- [x] **B-2.6** メール確認トークン生成 ✅
  - EmailVerificationToken テーブルに保存
  - 有効期限: 24時間
- [x] **B-2.7** 確認メール送信トリガー ✅ (2025-10-18完了)
- [x] **B-2.8** レスポンス返却 ✅
- [x] **B-2.9** トランザクション処理実装 ✅

#### B-3. SPONSOR登録エンドポイント
**API**: `POST /api/auth/register/sponsor`

- [x] **B-3.1** ルーティング設定 ✅
- [x] **B-3.2** コントローラー作成 ✅
- [x] **B-3.3** サービス層作成 ✅
- [x] **B-3.4** バリデーション実装 ✅
  - 屋号、担当者名、メールアドレス、パスワードの形式チェック
- [x] **B-3.5** ビジネスロジック実装 ✅
  - メールアドレス重複チェック
  - パスワードのハッシュ化 (bcrypt)
  - ユーザー作成 (Prisma)
  - 招待コードの `usedBy` 更新
  - 招待コードのステータス更新
- [x] **B-3.6** メール確認トークン生成 ✅
- [x] **B-3.7** 確認メール送信トリガー ✅ (2025-10-18完了)
- [x] **B-3.8** レスポンス返却 ✅
- [x] **B-3.9** トランザクション処理実装 ✅

---

### Phase 3: メール確認

#### B-4. 確認メール送信機能
**API**: `POST /api/auth/send-verification-email`

- [x] **B-4.1** メール送信サービス作成 (`/backend/src/services/email.service.ts`) ✅ (2025-10-18)
- [x] **B-4.2** SMTP設定 (環境変数) ✅ (2025-10-18)
- [x] **B-4.3** メールテンプレート作成 ✅ (2025-10-18)
  - 件名: 【HATAMO】メールアドレスの確認
  - 本文: 確認リンク含む
- [x] **B-4.4** メール送信ロジック実装 ✅ (2025-10-18)
- [x] **B-4.5** エラーハンドリング（送信失敗時） ✅ (2025-10-18)

#### B-5. メール確認エンドポイント
**API**: `GET /api/auth/verify-email?token=xxx`

- [x] **B-5.1** ルーティング設定 ✅ (2025-10-18)
- [x] **B-5.2** コントローラー作成 ✅ (2025-10-18)
- [x] **B-5.3** サービス層作成 ✅ (2025-10-18)
- [x] **B-5.4** トークン検証ロジック実装 ✅ (2025-10-18)
  - トークンの存在チェック (Prisma)
  - トークンの有効期限チェック (24時間以内)
  - トークンの未使用チェック
- [x] **B-5.5** ユーザー更新処理 ✅ (2025-10-18)
  - `emailVerified` を `true` に更新
  - トークンを使用済みに更新
- [x] **B-5.6** JWT トークン発行（自動ログイン用） ✅ (2025-10-18)
- [x] **B-5.7** レスポンス返却 ✅ (2025-10-18)
  - 成功時: JWT トークン
  - 失敗時: エラーメッセージ
- [x] **B-5.8** トランザクション処理実装 ✅ (2025-10-18)

---

### Phase 4: ログイン

#### B-6. ログインエンドポイント
**API**: `POST /api/auth/login`

- [ ] **B-6.1** ルーティング設定
- [ ] **B-6.2** コントローラー作成
- [ ] **B-6.3** サービス層作成
- [ ] **B-6.4** バリデーション実装
  - メールアドレス、パスワードの形式チェック
- [ ] **B-6.5** 認証ロジック実装
  - メールアドレスでユーザー検索 (Prisma)
  - パスワード検証 (bcrypt.compare)
- [ ] **B-6.6** JWT トークン発行
  - ペイロード: { userId, userType, emailVerified }
  - 有効期限: 7日
  - 署名: JWT_SECRET
- [ ] **B-6.7** レスポンス返却
  - 成功時: JWT トークン、ユーザー情報
  - 失敗時: 「メールアドレスまたはパスワードが間違っています」
- [ ] **B-6.8** エラーハンドリング実装

---

### Phase 5: 認証ミドルウェア

#### B-7. JWT認証ミドルウェア
**ファイル**: `/backend/src/middlewares/auth.middleware.ts`

- [ ] **B-7.1** JWT検証ミドルウェア作成
  - リクエストヘッダーまたはCookieからトークン取得
  - トークンの検証 (jwt.verify)
  - ペイロードをリクエストオブジェクトに格納 (`req.user`)
- [ ] **B-7.2** ユーザータイプチェックミドルウェア作成
  - CLIENT専用エンドポイント保護
  - SPONSOR専用エンドポイント保護
- [ ] **B-7.3** メール確認済みチェックミドルウェア作成
- [ ] **B-7.4** エラーハンドリング
  - トークン無効: 401 Unauthorized
  - トークン期限切れ: 401 Unauthorized

---

### Phase 6: セキュリティ・その他

#### B-8. セキュリティ実装

- [ ] **B-8.1** CSRF対策実装 (`csurf` ミドルウェア)
- [ ] **B-8.2** レート制限実装 (`express-rate-limit`)
  - ログインAPI: 15分間に5回まで
  - 登録API: 15分間に3回まで
- [ ] **B-8.3** CORS設定
- [ ] **B-8.4** Helmet.js 導入（セキュリティヘッダー）
- [x] **B-8.5** 環境変数の検証（起動時チェック） ✅ (2025-10-19)
  - `backend/src/utils/envValidator.ts` 実装完了
  - 必須環境変数: DATABASE_URL, JWT_SECRET, FRONTEND_URL
  - 起動時に `app.ts` で自動検証
  - 欠落時はエラーメッセージ表示してサーバー起動を中止

#### B-9. エラーハンドリング

- [ ] **B-9.1** 統一エラーハンドリングミドルウェア作成
- [ ] **B-9.2** カスタムエラークラス作成 (`AppError`)
- [ ] **B-9.3** Prismaエラーハンドリング
  - 一意制約違反 (P2002)
  - レコード未検出 (P2025)
- [ ] **B-9.4** ログ出力実装 (Winston)

#### B-10. バリデーション

- [ ] **B-10.1** Zod スキーマ定義 (`/backend/src/validators/`)
  - 招待コード検証スキーマ
  - CLIENT登録スキーマ
  - SPONSOR登録スキーマ
  - ログインスキーマ
- [ ] **B-10.2** バリデーションミドルウェア作成

---

## 🧪 テスト

### フロントエンド

- [ ] **T-F-1** 招待コード入力フォームの単体テスト
- [ ] **T-F-2** CLIENT登録フォームの単体テスト
- [ ] **T-F-3** SPONSOR登録フォームの単体テスト
- [ ] **T-F-4** ログインフォームの単体テスト
- [ ] **T-F-5** Middleware のアクセス制御テスト
- [ ] **T-F-6** 認証ストアの単体テスト
- [ ] **T-F-7** E2Eテスト (Playwright)
  - 新規登録フロー全体
  - ログインフロー全体
  - メール確認フロー

### バックエンド

- [ ] **T-B-1** 招待コード検証APIの単体テスト
- [ ] **T-B-2** CLIENT登録APIの単体テスト
- [ ] **T-B-3** SPONSOR登録APIの単体テスト
- [ ] **T-B-4** メール確認APIの単体テスト
- [ ] **T-B-5** ログインAPIの単体テスト
- [ ] **T-B-6** JWT認証ミドルウェアの単体テスト
- [ ] **T-B-7** バリデーションのテスト
- [ ] **T-B-8** エラーハンドリングのテスト
- [ ] **T-B-9** 統合テスト (Supertest)
  - 新規登録フロー全体
  - ログインフロー全体

---

## 📝 補足事項

### 実装順序の推奨

1. **B-1** → **F-1.6**: 招待コード検証機能（フロントエンド実装済み、API連携のみ）
2. **B-2, B-3** → **F-2, F-3**: 新規登録機能
3. **B-4, B-5** → **F-5**: メール確認機能
4. **B-6** → **F-6**: ログイン機能
5. **B-7** → **F-7**: 認証ミドルウェア
6. **B-8, B-9**: セキュリティ強化
7. **T-F-*, T-B-***: テスト実装

### 実装状況

#### 完了済み
- ✅ **F-1.1~F-1.5**: 招待コード入力ページ（UI・バリデーション・ローディング・エラー表示）
- ✅ **F-2 (全タスク)**: CLIENT登録ページ実装完了 (2025-10-18)
  - react-hook-form + zod によるバリデーション
  - 姓・名フィールドの分割実装
  - レスポンシブ対応（md:ブレークポイント）
  - アクセス制御（招待コード未検証時のリダイレクト）
  - API連携実装（JSON形式）
- ✅ **F-3 (全タスク)**: SPONSOR登録ページ実装完了 (2025-10-18)
  - react-hook-form + zod によるバリデーション
  - SPONSOR専用フィールド（屋号、担当者名、事業内容）
  - レスポンシブ対応（md:ブレークポイント）
  - アクセス制御（招待コード未検証時のリダイレクト）
  - API連携実装（JSON形式）
- ✅ **F-4 (全タスク)**: 登録完了ページ実装完了 (2025-10-18)
  - 登録完了メッセージ表示（成功アイコン、ステップ案内）
  - 確認メール再送信機能実装
  - Figmaデザイン準拠の統一UI
  - レスポンシブ対応実装
  - Suspense + client-side mount detection によるHydration対策
- ✅ **F-5 (全タスク)**: メール確認ページ実装完了 (2025-10-18)
  - トークン取得（useSearchParams + Suspense）
  - メール確認API呼び出し
  - ローディング・成功・エラー状態の表示切り替え
  - 自動ログイン + 自動リダイレクト実装
  - 詳細なエラーメッセージとリカバリーリンク
  - レスポンシブ対応実装
- ✅ **B-2 (全タスク)**: CLIENT登録エンドポイント実装完了 (2025-10-18)
- ✅ **B-3 (全タスク)**: SPONSOR登録エンドポイント実装完了 (2025-10-18)
- ✅ **B-4 (全タスク)**: 確認メール送信機能実装完了 (2025-10-18)
  - nodemailer によるメール送信サービス
  - SMTP設定（開発環境ではEthereal/console、本番環境ではSMTP）
  - HTMLメールテンプレート実装
  - エラーハンドリング実装
- ✅ **B-5 (全タスク)**: メール確認エンドポイント実装完了 (2025-10-18)
  - トークン検証ロジック（存在チェック、有効期限、未使用チェック）
  - ユーザーのemailVerified更新
  - JWT自動ログイントークン発行
  - トランザクション処理実装

#### 進行中
- 🔄 **F-1.6**: バックエンドAPI連携（B-1完了後に実装）
- 🔄 **B-1 (一部完了)**: 招待コード検証エンドポイント
  - ✅ ERR_EMPTY_RESPONSE エラー修正完了 (2025-10-19)
    - 原因: フロントエンドが port 5002 を参照していたが、バックエンドは port 5001 で起動
    - 修正: `frontend/.env.local` の `NEXT_PUBLIC_API_URL` を `http://localhost:5001/api` に変更
    - 注意: フロントエンドサーバーの再起動が必要

---

### 🐛 バグ修正履歴

#### メール確認500エラーの恒久的修正 (2025-10-19)
**問題**: メール確認API (`GET /api/auth/verify-email?token=xxx`) が常に500 Internal Server Errorを返す

**根本原因**:
- `.env` ファイルに `JWT_SECRET` などの必須環境変数が欠落
- JWT トークン生成時に `process.env.JWT_SECRET` が undefined となり、エラーがスロー
- 環境変数のバリデーションが起動時に行われていなかった

**実施した修正**:
1. **環境変数の追加** (`backend/.env`)
   - `JWT_SECRET`、`JWT_EXPIRES_IN`、`NODE_ENV`、`ENABLE_EMAIL`、SMTP設定など
   - `.env.example` の内容を `.env` に反映

2. **環境変数バリデーション機能の追加** (`backend/src/utils/envValidator.ts`)
   - 必須環境変数のチェック（`DATABASE_URL`、`JWT_SECRET`、`FRONTEND_URL`）
   - オプション変数へのデフォルト値設定
   - 本番環境でのJWT_SECRETセキュリティチェック
   - 起動時に環境変数が欠落している場合、エラーメッセージを表示してサーバー起動を停止

3. **起動時バリデーションの統合** (`backend/src/app.ts`)
   - `dotenv.config()` 後に `validateEnv()` を呼び出し
   - 環境変数エラー時は `process.exit(1)` でサーバー起動を中止

4. **JWT エラーメッセージの改善** (`backend/src/utils/jwt.ts`)
   - JWT_SECRET欠落時により詳細なエラーメッセージを表示

**テスト結果**:
- ✅ 有効なトークン: JWT発行 + ユーザーデータ返却
- ✅ 無効なトークン: 適切なエラーメッセージ
- ✅ 使用済みトークン: 適切なエラーメッセージ
- ✅ トークン未指定: 適切なエラーメッセージ

**再発防止策**:
- サーバー起動時に必須環境変数を自動検証
- 環境変数欠落時はサーバーが起動しないため、同様のエラーは発生しない

---

### 依存関係

- フロントエンドタスクは対応するバックエンドAPIの完成後に実装可能
- Middleware (F-7) は全API実装後に統合テスト
- セキュリティ機能 (B-8) は並行して実装可能

### 環境変数

以下の環境変数が必要:
```bash
# JWT
JWT_SECRET="your-secret-key"
JWT_EXPIRES_IN="7d"

# Email (SMTP)
SMTP_HOST="smtp.example.com"
SMTP_PORT="587"
SMTP_USER="your-email@example.com"
SMTP_PASS="your-password"

# Frontend URL
FRONTEND_URL="http://localhost:3000"
```

---

**次のステップ**: 各タスクを順次実装し、チェックボックスを更新していきます。
